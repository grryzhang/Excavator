<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
  
<mapper namespace="com.zhongzhou.Excavator.DAO.postgresql.ItemDAO">  
    
    <resultMap type="Item" id="itemMap">
		<result property="id"              column="id"               />
    	<result property="name"            column="name"             />
		<result property="eName"           column="e_name"           />
		<result property="itemCode"        column="item_code"        />
		<result property="itemType"        column="item_type"        />
		<result property="specification"   column="specification"    />
		<result property="lastUpdateTime"  column="last_update_time" />
    </resultMap> 

    <resultMap type="ItemMapping" id="itemMappingMap">
		<result property="id"              column="id"               />
    	<result property="itemId"          column="item_id"          />
    	<result property="itemCode"        column="item_code"          />
		<result property="sourceId"        column="source_id"        />
		<result property="dataSource"      column="data_source"      />
    </resultMap>    
    	
	<resultMap type="ItemCategory" id="itemCategoryMap">
		<result property="id"              column="id"             />
    	<result property="name"            column="name"             />
		<result property="ename"           column="e_name"           />
		<result property="description"     column="description"      />
		<result property="categoryGroup"   column="category_group"   />
		<result property="level"           column="level"            />
        <result property="parentId"        column="parent_id"        />
        <result property="isLeaf"          column="is_leaf"          />
        <result property="treeLeftValue"   column="tree_left_value"  />
        <result property="treeRightValue"  column="tree_right_value" />
        <result property="lastUpdateTime"  column="last_update_time" />
        <result property="status"          column="status"           />
    </resultMap>     
    
    <resultMap type="ItemCategoryMapping" id="itemCategoryMappingMap">
    	<result property="id"             column="id"      />
		<result property="categoryId"     column="category_id"  />
		<result property="sourceId"       column="source_id"    />
		<result property="dataSource"     column="data_source"  />
		<result property="sourceParentId" column="source_parent_id"  />
    </resultMap>   
    
    <sql id="itemColumn">
    	i.id, i.name,i.e_name,i.item_code,i.specification,
    	i.item_type,
    	i.last_update_time
    </sql>
    <sql id="itemMappingColumn">
    	ii2s.id, ii2s.item_id, ii2s.source_id, ii2s.data_source
    </sql>
    <sql id="itemMappingWhere">
    	ii2s.source_id is not null
    	<if test = "sourceIds != null and sourceIds.size() &gt; 0 ">
            and ii2s.source_id in 
            <foreach item="item" index="index" collection="sourceIds" open="(" separator="," close=")">  
            	#{item}  
            </foreach>
         </if>
    </sql>
    <sql id="itemCategoryColumn">
    	ic.id, ic.name,ic.e_name,ic.description,
    	ic.category_group,ic.level,ic.parent_id,ic.is_leaf,ic.tree_left_value,ic.tree_right_value,ic.status,
    	ic.last_update_time
    </sql>
    <sql id="itemCategoryWhere">
    	ic.id is not null
    	<if test = "level != null">
            and ic.level = #{level}  
        </if>
    	
    	<if test = "sourceIds != null and sourceIds.size() &gt; 0 ">
            and iic2s.source_id in 
            <foreach item="item" index="index" collection="sourceIds" open="(" separator="," close=")">  
            	#{item}  
            </foreach>
         </if>
    </sql>
    <sql id="itemCategoryMappingColumn">
    	iic2s.id,iic2s.category_id,iic2s.source_id,iic2s.source_parent_id,
    	iic2s.data_source  
    </sql>
    <sql id="itemCategoryMappingWhere">
    	iic2s.source_id is not null
    	<if test = "sourceIds != null and sourceIds.size() &gt; 0 ">
            and iic2s.source_id in 
            <foreach item="item" index="index" collection="sourceIds" open="(" separator="," close=")">  
            	#{item}  
            </foreach>
         </if>
    </sql>

	<insert id="insertItems" parameterType="java.util.List">
        insert into items
        (
        	id,
        	name,
        	e_name,
    		item_code,
    		specification,
    		item_type,
    		last_update_time
        )
        values
        <foreach collection="list" item="item" index="index" separator="," >  
        ( 
        	cast( #{item.id} as uuid ),
        	#{item.name},
        	#{item.eName},
        	#{item.itemCode},
        	#{item.specification},
        	#{item.itemType},
        	#{item.lastUpdateTime}
       	)
       	</foreach>
    </insert>
    
    <update id="updateItems" parameterType="java.util.List">
    
    	<foreach collection="list" item="item" index="index" separator=";" >  
    	update 
    		corporation
    	set
    		name                =  #{item.name},               
        	e_name              =  #{item.eName},          
    		item_code           =  #{item.itemCode}, 
    		specification       =  #{item.specification}, 
    		item_type       	=  #{item.itemType},           
    		last_update_time    =  #{item.lastUpdateTime}
		where id = cast( #{item.id} as uuid )
		</foreach>
		
    </update>
    
    <insert id="insertItemMappings" parameterType="java.util.List">
        insert into inter_item_2_source
        (
        	id,
        	item_id,
        	item_code,
        	source_id,
    		data_source
        )
        values
        <foreach collection="list" item="item" index="index" separator="," >  
        ( 
        	cast( #{item.id} as uuid ),
        	cast( #{item.itemId} as uuid ),
        	#{item.itemCode},
        	#{item.sourceId},
        	#{item.dataSource}
       	)
       	</foreach>
    </insert>

    <select id="selectItemMappings" 
    		parameterType="ItemSearchParameters"   
    		resultMap="itemMappingMap">
		select 
			<include refid="itemMappingColumn"/>
		from 
			inter_item_2_source ii2s
		where
		<include refid="itemMappingWhere"/>
    </select> 

	<insert id="insertItemCategory" parameterType="ItemCategory">
		update 
			item_categorys 
		set 
			tree_left_value = tree_left_value + 2
		where 
			tree_left_value &gt;= #{treeLeftValue};

		update 
			item_categorys 
		set 
			tree_right_value = tree_right_value + 2
		where
			tree_right_value &gt;= #{treeLeftValue};

		insert into 
			item_categorys
			( 
				id, name, e_name, description, level, parent_id, 
			  	is_leaf, tree_left_value, tree_right_value, status, category_group 
			)
		values
			( 	
				cast( #{id} as uuid ), #{name}, #{ename}, #{description}, #{level}, cast( #{parentId} as uuid ), 
				#{isLeaf}, #{treeLeftValue}, #{treeRightValue}, #{status}, #{categoryGroup} 
			)
	</insert>

	<insert id="insertItemCategoryMapping" parameterType="ItemCategoryMapping">
		insert into 
			inter_item_category_2_source
        	(
        		id,
        		category_id,
        		source_id,
        		source_parent_id,
        		data_source
        	)
        values
        	( 
        		cast( #{id} as uuid ),
        		cast( #{categoryId} as uuid ),
        		#{sourceId},
        		#{sourceParentId},
        		#{dataSource}
       		)
	</insert>
	
	<update id="updateIsLeaf">
    	update item_categorys 
			set is_leaf = 'f'
		where tree_right_value != tree_left_value + 1;
		
		update item_categorys 
			set is_leaf = 't'
		where tree_right_value = tree_left_value + 1
    </update>
    
    <update id="updateItemCategory" parameterType="ItemCategory">
    	update 
    		item_categorys
    	set
    		name       = #{name},
    		e_name     = #{ename}
		where id = #{id}
    </update>


    <select id="selectItemCategorys" 
    		parameterType="ItemCategorySearchParameters"   
    		resultMap="itemCategoryMap">
		select 
			<include refid="itemCategoryColumn"/>
		from 
			item_categorys ic
		left join
		    inter_item_category_2_source iic2s
		    on
		    ic.id = iic2s.category_id
		where
		<include refid="itemCategoryWhere"/>
    </select> 

    <select id="selectItemCategorysMapping" 
    		parameterType="ItemCategoryMappingSearchParameters"   
    		resultMap="itemCategoryMappingMap">
		select 
			<include refid="itemCategoryMappingColumn"/>
		from 
		    inter_item_category_2_source iic2s
		where
		<include refid="itemCategoryMappingWhere"/>
    </select> 
    
</mapper>  